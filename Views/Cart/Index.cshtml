@using BookStoreMVC.Models.Entities;
@model BookStoreMVC.Models.ViewModels.CartViewModel;

@{
    ViewData["Title"] = "Giỏ hàng";
}

<div class="bg-gray-50 min-h-screen">
    <!-- Page Header -->
    <div class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-bold text-gray-900">Giỏ hàng của bạn</h1>
                <a asp-controller="Books" asp-action="Index" 
                   class="text-blue-600 hover:text-blue-800 font-medium transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Tiếp tục mua sắm
                </a>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        @if (Model?.Items?.Any() == true)
        {
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Cart Items -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-900">Sản phẩm trong giỏ (@Model.Items.Count)</h2>
                        </div>

                        <div class="divide-y divide-gray-200">
                            @foreach (var item in Model.Items)
                            {
                                <div class="p-6 cart-item" data-item-id="@item.Id">
                                    <div class="flex flex-col md:flex-row gap-6">
                                        <!-- Product Image -->
                                        <div class="md:w-32 flex-shrink-0">
                                            <img src="@(item.Book.ImageUrl ?? "https://via.placeholder.com/200x300")" 
                                                 alt="@item.Book.Title" 
                                                 class="w-full h-40 md:h-32 object-cover rounded-lg">
                                        </div>

                                        <!-- Product Info -->
                                        <div class="flex-1">
                                            <div class="flex flex-col md:flex-row md:justify-between">
                                                <div class="flex-1 mb-4 md:mb-0">
                                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">
                                                        <a asp-controller="Books" asp-action="Details" asp-route-id="@item.BookId" 
                                                           class="hover:text-blue-600 transition-colors">
                                                            @item.Book.Title
                                                        </a>
                                                    </h3>
                                                    <p class="text-gray-600 mb-2">Tác giả: @item.Book.Author</p>
                                                    
                                                    @if (item.Book.Category != null)
                                                    {
                                                        <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">
                                                            @item.Book.Category.NameCategory
                                                        </span>
                                                    }

                                                    <!-- Stock Warning -->
                                                    @if (item.Book.StockQuantity < item.Quantity)
                                                    {
                                                        <div class="mt-2 p-2 bg-yellow-50 border-l-4 border-yellow-400">
                                                            <div class="flex">
                                                                <div class="flex-shrink-0">
                                                                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                                                </div>
                                                                <div class="ml-3">
                                                                    <p class="text-sm text-yellow-700">
                                                                        Chỉ còn @item.Book.StockQuantity sản phẩm trong kho
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }
                                                    else if (item.Book.StockQuantity <= 0)
                                                    {
                                                        <div class="mt-2 p-2 bg-red-50 border-l-4 border-red-400">
                                                            <div class="flex">
                                                                <div class="flex-shrink-0">
                                                                    <i class="fas fa-times-circle text-red-400"></i>
                                                                </div>
                                                                <div class="ml-3">
                                                                    <p class="text-sm text-red-700">
                                                                        Sản phẩm đã hết hàng
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>

                                                <!-- Price & Actions -->
                                                <div class="text-right">
                                                    <!-- Price -->
                                                    <div class="mb-4">
                                                        @{
                                                            var effectivePrice = item.Book.DiscountPrice ?? item.Book.Price;
                                                        }
                                                        
                                                        @if (item.Book.DiscountPrice.HasValue && item.Book.DiscountPrice < item.Book.Price)
                                                        {
                                                            <div class="text-lg font-bold text-red-600">@effectivePrice.ToString("C0")</div>
                                                            <div class="text-sm text-gray-500 line-through">@item.Book.Price.ToString("C0")</div>
                                                        }
                                                        else
                                                        {
                                                            <div class="text-lg font-bold text-gray-900">@effectivePrice.ToString("C0")</div>
                                                        }
                                                        
                                                        <div class="text-sm text-gray-600">Đơn giá</div>
                                                    </div>

                                                    <!-- Quantity Controls -->
                                                    <div class="flex items-center justify-end space-x-3 mb-4">
                                                        <span class="text-sm text-gray-600">Số lượng:</span>
                                                        <div class="flex items-center border border-gray-300 rounded-lg">
                                                            <button type="button" onclick="updateQuantity(@item.Id, @(item.Quantity - 1))" 
                                                                    class="px-3 py-1 text-gray-600 hover:bg-gray-100 transition-colors @(item.Quantity <= 1 ? "opacity-50 cursor-not-allowed" : "")"
                                                                    @(item.Quantity <= 1 ? "disabled" : "")>
                                                                <i class="fas fa-minus"></i>
                                                            </button>
                                                            <span class="px-4 py-1 text-center min-w-[3rem]" id="quantity-@item.Id">@item.Quantity</span>
                                                            <button type="button" onclick="updateQuantity(@item.Id, @(item.Quantity + 1))" 
                                                                    class="px-3 py-1 text-gray-600 hover:bg-gray-100 transition-colors @(item.Quantity >= item.Book.StockQuantity ? "opacity-50 cursor-not-allowed" : "")"
                                                                    @(item.Quantity >= item.Book.StockQuantity ? "disabled" : "")>
                                                                <i class="fas fa-plus"></i>
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Subtotal -->
                                                    <div class="mb-4">
                                                        <div class="text-xl font-bold text-gray-900" id="subtotal-@item.Id">
                                                            @((effectivePrice * item.Quantity).ToString("C0"))
                                                        </div>
                                                        <div class="text-sm text-gray-600">Thành tiền</div>
                                                    </div>

                                                    <!-- Remove Button -->
                                                    <button onclick="removeFromCart(@item.Id)" 
                                                            class="text-red-600 hover:text-red-800 transition-colors">
                                                        <i class="fas fa-trash mr-1"></i>
                                                        Xóa
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Cart Actions -->
                        <div class="p-6 bg-gray-50 border-t border-gray-200">
                            <div class="flex flex-col sm:flex-row sm:justify-between space-y-3 sm:space-y-0">
                                <button onclick="clearCart()" 
                                        class="text-red-600 hover:text-red-800 font-medium transition-colors">
                                    <i class="fas fa-trash mr-2"></i>
                                    Xóa tất cả
                                </button>
                                <button onclick="updateCart()" 
                                        class="bg-gray-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-gray-700 transition-colors">
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Cập nhật giỏ hàng
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden sticky top-24">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Tổng đơn hàng</h3>
                        </div>

                        <div class="p-6 space-y-4">
                            <!-- Subtotal -->
                            <div class="flex justify-between">
                                <span class="text-gray-600">Tạm tính:</span>
                                <span class="font-semibold" id="cart-subtotal">@Model.SubTotal.ToString("C0")</span>
                            </div>

                            <!-- Shipping -->
                            <div class="flex justify-between">
                                <span class="text-gray-600">Phí vận chuyển:</span>
                                <span class="font-semibold">
                                    @if (Model.SubTotal >= 500000)
                                    {
                                        <span class="text-green-600">Miễn phí</span>
                                    }
                                    else
                                    {
                                        <span>30.000đ</span>
                                    }
                                </span>
                            </div>

                            <!-- Free shipping progress -->
                            @if (Model.SubTotal < 500000)
                            {
                                var remaining = 500000 - Model.SubTotal;
                                var progress = (Model.SubTotal / 500000m) * 100;
                                
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <div class="text-sm text-blue-800 mb-2">
                                        Mua thêm <span class="font-semibold">@remaining.ToString("C0")</span> để được miễn phí vận chuyển
                                    </div>
                                    <div class="w-full bg-blue-200 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: @progress%"></div>
                                    </div>
                                </div>
                            }

                            <!-- Discount Code -->
                            <div class="border-t border-gray-200 pt-4">
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mã giảm giá</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="discount-code" placeholder="Nhập mã giảm giá..." 
                                               class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <button onclick="applyDiscount()" 
                                                class="bg-gray-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-gray-700 transition-colors">
                                            Áp dụng
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Applied discount -->
                                <div id="applied-discount" class="hidden">
                                    <div class="flex justify-between text-green-600">
                                        <span>Giảm giá:</span>
                                        <span id="discount-amount">-0đ</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Total -->
                            <div class="border-t border-gray-200 pt-4">
                                <div class="flex justify-between text-xl font-bold">
                                    <span>Tổng cộng:</span>
                                    <span class="text-blue-600" id="cart-total">
                                        @{
                                            var shippingFee = Model.SubTotal >= 500000 ? 0 : 30000;
                                            var finalTotal = Model.SubTotal + shippingFee;
                                        }
                                        @finalTotal.ToString("C0")
                                    </span>
                                </div>
                            </div>

                            <!-- Checkout Button -->
                            <div class="pt-4">
                                @if (User.Identity.IsAuthenticated)
                                {
                                    <a asp-controller="Orders" asp-action="Checkout" 
                                       class="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors block text-center">
                                        <i class="fas fa-credit-card mr-2"></i>
                                        Thanh toán
                                    </a>
                                }
                                else
                                {
                                    <div class="space-y-3">
                                        <a asp-area="Identity" asp-page="/Account/Login" asp-route-returnUrl="@Url.Action("Checkout", "Orders")"
                                           class="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors block text-center">
                                            <i class="fas fa-sign-in-alt mr-2"></i>
                                            Đăng nhập để thanh toán
                                        </a>
                                        <p class="text-sm text-gray-600 text-center">
                                            Chưa có tài khoản? 
                                            <a asp-area="Identity" asp-page="/Account/Register" class="text-blue-600 hover:text-blue-800 font-medium">
                                                Đăng ký ngay
                                            </a>
                                        </p>
                                    </div>
                                }
                            </div>

                            <!-- Security Info -->
                            <div class="text-center text-sm text-gray-500 pt-4 border-t border-gray-200">
                                <div class="flex items-center justify-center space-x-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-shield-alt text-green-500 mr-1"></i>
                                        <span>Bảo mật SSL</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-undo text-blue-500 mr-1"></i>
                                        <span>Đổi trả 30 ngày</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- Empty Cart -->
            <div class="text-center py-16">
                <div class="max-w-md mx-auto">
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <i class="fas fa-shopping-cart text-6xl text-gray-300 mb-6"></i>
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">Giỏ hàng trống</h2>
                        <p class="text-gray-600 mb-8">Bạn chưa có sản phẩm nào trong giỏ hàng. Hãy khám phá các sản phẩm tuyệt vời của chúng tôi!</p>
                        <a asp-controller="Books" asp-action="Index" 
                           class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                            <i class="fas fa-search mr-2"></i>
                            Khám phá sách
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Update quantity
        async function updateQuantity(itemId, newQuantity) {
            if (newQuantity < 1) return;
            
            try {
                const response = await fetch('@Url.Action("UpdateQuantity", "Cart")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({
                        itemId: itemId,
                        quantity: newQuantity
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Update UI
                        document.getElementById(`quantity-${itemId}`).textContent = newQuantity;
                        document.getElementById(`subtotal-${itemId}`).textContent = result.subtotal;
                        document.getElementById('cart-subtotal').textContent = result.cartTotal;
                        document.getElementById('cart-total').textContent = result.finalTotal;
                        
                        // Update cart count
                        updateCartCount(result.totalItems);
                        
                        showToast('Cập nhật số lượng thành công', 'success');
                    } else {
                        showToast(result.message || 'Có lỗi xảy ra', 'error');
                    }
                } else {
                    showToast('Có lỗi xảy ra khi cập nhật', 'error');
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
                showToast('Có lỗi xảy ra', 'error');
            }
        }

        // Remove item from cart
        async function removeFromCart(itemId) {
            if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?')) {
                return;
            }

            try {
                const response = await fetch('@Url.Action("RemoveItem", "Cart")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({ itemId: itemId })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Remove item from UI
                        document.querySelector(`[data-item-id="${itemId}"]`).remove();
                        
                        // Update totals
                        if (result.totalItems > 0) {
                            document.getElementById('cart-subtotal').textContent = result.cartTotal;
                            document.getElementById('cart-total').textContent = result.finalTotal;
                        } else {
                            // Reload page if cart is empty
                            window.location.reload();
                        }
                        
                        // Update cart count
                        updateCartCount(result.totalItems);
                        
                        showToast('Đã xóa sản phẩm khỏi giỏ hàng', 'success');
                    } else {
                        showToast(result.message || 'Có lỗi xảy ra', 'error');
                    }
                } else {
                    showToast('Có lỗi xảy ra khi xóa sản phẩm', 'error');
                }
            } catch (error) {
                console.error('Error removing item:', error);
                showToast('Có lỗi xảy ra', 'error');
            }
        }

        // Clear cart
        async function clearCart() {
            if (!confirm('Bạn có chắc chắn muốn xóa tất cả sản phẩm trong giỏ hàng?')) {
                return;
            }

            try {
                const response = await fetch('@Url.Action("Clear", "Cart")', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        window.location.reload();
                    } else {
                        showToast(result.message || 'Có lỗi xảy ra', 'error');
                    }
                } else {
                    showToast('Có lỗi xảy ra khi xóa giỏ hàng', 'error');
                }
            } catch (error) {
                console.error('Error clearing cart:', error);
                showToast('Có lỗi xảy ra', 'error');
            }
        }

        // Update cart
        function updateCart() {
            window.location.reload();
        }

        // Apply discount code
        async function applyDiscount() {
            const discountCode = document.getElementById('discount-code').value.trim();
            if (!discountCode) {
                showToast('Vui lòng nhập mã giảm giá', 'error');
                return;
            }

            try {
                const response = await fetch('@Url.Action("ApplyDiscount", "Cart")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({ discountCode: discountCode })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Update UI with discount
                        document.getElementById('discount-amount').textContent = '-' + result.discountAmount;
                        document.getElementById('applied-discount').classList.remove('hidden');
                        document.getElementById('cart-total').textContent = result.finalTotal;
                        
                        showToast('Áp dụng mã giảm giá thành công', 'success');
                    } else {
                        showToast(result.message || 'Mã giảm giá không hợp lệ', 'error');
                    }
                } else {
                    showToast('Có lỗi xảy ra khi áp dụng mã giảm giá', 'error');
                }
            } catch (error) {
                console.error('Error applying discount:', error);
                showToast('Có lỗi xảy ra', 'error');
            }
        }

        // Load cart count on page load
        loadCartCount();
    </script>
}