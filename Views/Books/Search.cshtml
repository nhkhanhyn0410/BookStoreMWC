@* @model BookViewModel
@{
    ViewData["Title"] = $"Kết quả tìm kiếm: {Model.Query}";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <!-- Breadcrumb -->
    @await Html.PartialAsync("_Breadcrumb", new List<(string, string)> {
        ("Trang chủ", Url.Action("Index", "Home")),
        ("Sách", Url.Action("Index", "Books")),
        ("Tìm kiếm", "")
    })

    <!-- Search Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="search-header">
                <h2>
                    Kết quả tìm kiếm cho: 
                    <span class="text-primary">"@Model.Query"</span>
                </h2>
                <p class="text-muted">
                    Tìm thấy <strong>@Model.TotalResults</strong> kết quả 
                    trong <strong>@Model.SearchTime ms</strong>
                </p>
            </div>
        </div>
    </div>

    @if (Model.TotalResults > 0)
    {
        <!-- Advanced Search -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0" data-bs-toggle="collapse" data-bs-target="#advancedSearch">
                    <i class="fas fa-search-plus"></i> Tìm kiếm nâng cao
                    <i class="fas fa-chevron-down float-end"></i>
                </h5>
            </div>
            <div class="collapse" id="advancedSearch">
                <div class="card-body">
                    <form method="get" asp-action="Search">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group mb-3">
                                    <label class="form-label">Từ khóa</label>
                                    <input type="text" name="query" class="form-control" value="@Model.Query">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-3">
                                    <label class="form-label">Danh mục</label>
                                    <select name="categoryId" class="form-select">
                                        <option value="">Tất cả</option>
                                        @foreach (var cat in Model.Categories)
                                        {
                                            <option value="@cat.Id" selected="@(cat.Id == Model.SelectedCategory)">
                                                @cat.Name
                                            </option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-3">
                                    <label class="form-label">Tác giả</label>
                                    <input type="text" name="author" class="form-control" value="@Model.AuthorFilter">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-3">
                                    <label class="form-label">Giá từ</label>
                                    <input type="number" name="minPrice" class="form-control" value="@Model.MinPrice">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-3">
                                    <label class="form-label">Giá đến</label>
                                    <input type="number" name="maxPrice" class="form-control" value="@Model.MaxPrice">
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="form-group mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check form-check-inline">
                                    <input type="checkbox" name="inStock" class="form-check-input" 
                                           @(Model.InStockOnly ? "checked" : "")>
                                    <label class="form-check-label">Còn hàng</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input type="checkbox" name="featured" class="form-check-input" 
                                           @(Model.FeaturedOnly ? "checked" : "")>
                                    <label class="form-check-label">Nổi bật</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input type="checkbox" name="hasReviews" class="form-check-input" 
                                           @(Model.HasReviews ? "checked" : "")>
                                    <label class="form-check-label">Có đánh giá</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <!-- Search Suggestions -->
                @if (Model.Suggestions.Any())
                {
                    <p class="text-muted mb-2">
                        Có thể bạn muốn tìm: 
                        @foreach (var suggestion in Model.Suggestions)
                        {
                            <a asp-action="Search" asp-route-query="@suggestion" class="text-decoration-none me-2">
                                <span class="badge badge-light">@suggestion</span>
                            </a>
                        }
                    </p>
                }
            </div>
            
            <div>
                <!-- Sort Options -->
                <select class="form-select form-select-sm" style="width: auto;" onchange="updateSort(this.value)">
                    <option value="relevance" selected="@(Model.SortBy == "relevance")">Liên quan nhất</option>
                    <option value="newest" selected="@(Model.SortBy == "newest")">Mới nhất</option>
                    <option value="price-asc" selected="@(Model.SortBy == "price-asc")">Giá thấp đến cao</option>
                    <option value="price-desc" selected="@(Model.SortBy == "price-desc")">Giá cao đến thấp</option>
                    <option value="rating" selected="@(Model.SortBy == "rating")">Đánh giá cao</option>
                    <option value="popular" selected="@(Model.SortBy == "popular")">Phổ biến</option>
                </select>
            </div>
        </div>

        <!-- Results -->
        <div class="row">
            @foreach (var book in Model.Books)
            {
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    @await Html.PartialAsync("_BookCard", book)
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            @await Html.PartialAsync("_Pagination", Model)
        }
    }
    else
    {
        <!-- No Results -->
        <div class="text-center py-5">
            <i class="fas fa-search fa-5x text-muted mb-4"></i>
            <h3>Không tìm thấy kết quả nào</h3>
            <p class="text-muted mb-4">
                Không có sách nào phù hợp với từ khóa "<strong>@Model.Query</strong>"
            </p>
            
            <div class="search-suggestions">
                <h5>Gợi ý tìm kiếm:</h5>
                <ul class="list-unstyled">
                    <li>• Kiểm tra lại chính tả</li>
                    <li>• Sử dụng từ khóa khác</li>
                    <li>• Tìm kiếm với từ khóa tổng quát hơn</li>
                    <li>• Thử tìm theo tên tác giả hoặc nhà xuất bản</li>
                </ul>
            </div>

            <div class="popular-searches mt-4">
                <h6>Từ khóa phổ biến:</h6>
                @foreach (var keyword in Model.PopularKeywords)
                {
                    <a asp-action="Search" asp-route-query="@keyword" class="btn btn-outline-primary btn-sm me-2 mb-2">
                        @keyword
                    </a>
                }
            </div>

            <div class="mt-4">
                <a asp-action="Index" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> Quay lại danh sách sách
                </a>
            </div>
        </div>
    }
</div>

<script>
function updateSort(sortValue) {
    const url = new URL(window.location);
    url.searchParams.set('sortBy', sortValue);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

// Highlight search terms
$(document).ready(function() {
    const searchTerm = '@Model.Query';
    if (searchTerm) {
        $('.card-title, .card-text').each(function() {
            const text = $(this).html();
            const regex = new RegExp('(' + searchTerm + ')', 'gi');
            const highlighted = text.replace(regex, '<mark>$1</mark>');
            $(this).html(highlighted);
        });
    }
});
</script> *@
