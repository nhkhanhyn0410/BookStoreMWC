@* Views/Admin/Books.cshtml *@
@model BookStoreMVC.Models.ViewModels.BookListViewModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Quản lý sách";
    ViewBag.PageTitle = "Quản lý sách";
    ViewBag.ActiveMenu = "Books";
}

<!-- Page Header with Actions -->
<div class="mb-6">
    <div class="sm:flex sm:items-center sm:justify-between">
        <div>
            <h2 class="text-xl font-semibold text-gray-900 mb-2">Quản lý sách</h2>
            <p class="text-sm text-gray-600">Tổng cộng: <span class="font-medium">@(Model?.TotalCount ?? 0)</span> cuốn sách</p>
        </div>
        <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
            <a href="@Url.Action("CreateBook", "Admin")" 
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                <i class="fas fa-plus mr-2"></i>
                Thêm sách mới
            </a>
        </div>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
    <div class="p-6">
        <form method="get" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Search -->
                <div class="md:col-span-2">
                    <label for="SearchTerm" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm</label>
                    <div class="relative">
                        <input type="text" id="SearchTerm" name="SearchTerm" value="@Model.SearchTerm"
                               placeholder="Tìm theo tên sách, tác giả..."
                               class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Category Filter -->
                <div>
                    <label for="CategoryId" class="block text-sm font-medium text-gray-700 mb-1">Danh mục</label>
                    <select id="CategoryId" name="CategoryId" 
                            class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Tất cả danh mục</option>
                        @if (Model?.Categories != null)
                        {
                            @foreach (var category in Model.Categories)
                            {
                                @* <option value="@category.Id" @(Model.CategoryId == category.Id ? "selected" : "")>
                                    @category.Name
                                </option> *@
                            }
                        }
                    </select>
                </div>

                <!-- Sort -->
                <div>
                    <label for="SortBy" class="block text-sm font-medium text-gray-700 mb-1">Sắp xếp</label>
                    <select id="SortBy" name="SortBy" 
                            @* class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                        <option value="newest" @(Model.SortBy == "newest" ? "selected" : "")>Mới nhất</option>
                        <option value="oldest" @(Model.SortBy == "oldest" ? "selected" : "")>Cũ nhất</option>
                        <option value="title" @(Model.SortBy == "title" ? "selected" : "")>Tên A-Z</option>
                        <option value="price_low" @(Model.SortBy == "price_low" ? "selected" : "")>Giá thấp-cao</option>
                        <option value="price_high" @(Model.SortBy == "price_high" ? "selected" : "")>Giá cao-thấp</option> *@
                    </select>
                </div>
            </div>

            <!-- Filter Actions -->
            <div class="flex items-center justify-between">
                <div class="flex space-x-2">
                    <button type="submit" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        Tìm kiếm
                    </button>
                    <a href="@Url.Action("Books", "Admin")" 
                       class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                        <i class="fas fa-times mr-2"></i>
                        Xóa bộ lọc
                    </a>
                </div>

                <!-- Bulk Actions -->
                <div class="flex space-x-2">
                    <button type="button" id="bulk-delete" 
                            class="inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-lg text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors disabled:opacity-50"
                            disabled>
                        <i class="fas fa-trash mr-2"></i>
                        Xóa đã chọn
                    </button>
                    <button type="button" onclick="$('#bulk-upload-modal').removeClass('hidden')"
                            class="inline-flex items-center px-4 py-2 border border-green-300 text-sm font-medium rounded-lg text-green-700 bg-white hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                        <i class="fas fa-upload mr-2"></i>
                        Upload ảnh
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Books Table -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <!-- Table Header -->
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center">
            <input type="checkbox" id="select-all" 
                   class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
            <label for="select-all" class="ml-3 text-sm font-medium text-gray-700">
                Chọn tất cả
            </label>
        </div>
    </div>

    <!-- Table Content -->
    <div class="overflow-x-auto">
        @if (Model?.Books?.Any() == true)
        {
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input type="checkbox" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Sách
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Danh mục
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Giá
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Tồn kho
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Trạng thái
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Thao tác
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @foreach (var book in Model.Books)
                    {
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="checkbox" name="selectedBooks" value="@book.Id"
                                       class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded book-checkbox">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-16 w-12">
                                        <img class="h-16 w-12 object-cover rounded-lg border border-gray-200" 
                                             src="@(book.ImageUrl ?? "/images/books/default-book.jpg")" 
                                             alt="@book.Title"
                                             onerror="this.src='/images/books/default-book.jpg'">
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900 max-w-xs truncate">
                                            @book.Title
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            @book.Author
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            @* ISBN: @book.ISBN *@
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    @* @book.CategoryName *@
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">@book.Price.ToString("C0")</div>
                                @if (book.DiscountPrice.HasValue && book.DiscountPrice > 0)
                                {
                                    <div class="text-sm text-red-600">@book.DiscountPrice.Value.ToString("C0")</div>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">@book.StockQuantity</div>
                                @if (book.StockQuantity <= 5)
                                {
                                    <div class="text-xs text-red-600">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>Sắp hết
                                    </div>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                @if (book.IsActive)
                                {
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-circle mr-1 text-xs"></i>Hoạt động
                                    </span>
                                }
                                else
                                {
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        <i class="fas fa-circle mr-1 text-xs"></i>Tạm dừng
                                    </span>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <div class="flex items-center space-x-2">
                                    <!-- Edit -->
                                    <a href="@Url.Action("EditBook", "Admin", new { id = book.Id })" 
                                       class="text-primary-600 hover:text-primary-900 transition-colors"
                                       title="Chỉnh sửa">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    
                                    <!-- Upload Image -->
                                    <button onclick="showImageUploadModal(@book.Id, '@book.Title')" 
                                            class="text-green-600 hover:text-green-900 transition-colors"
                                            title="Upload ảnh">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                    
                                    <!-- View Details -->
                                    <a href="@Url.Action("Details", "Books", new { id = book.Id })" 
                                       target="_blank"
                                       class="text-blue-600 hover:text-blue-900 transition-colors"
                                       title="Xem chi tiết">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    <!-- Delete -->
                                    <button onclick="deleteBook(@book.Id, '@book.Title')" 
                                            class="text-red-600 hover:text-red-900 transition-colors"
                                            title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <!-- Empty State -->
            <div class="text-center py-12">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-book text-gray-400 text-3xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Không có sách nào</h3>
                <p class="text-sm text-gray-500 mb-6">
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <span>Không tìm thấy sách nào với từ khóa "<strong>@Model.SearchTerm</strong>"</span>
                    }
                    else
                    {
                        <span>Chưa có sách nào trong hệ thống. Hãy thêm sách đầu tiên!</span>
                    }
                </p>
                <a href="@Url.Action("CreateBook", "Admin")" 
                   class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    Thêm sách mới
                </a>
            </div>
        }
    </div>

    <!-- Pagination -->
    @if (Model?.TotalCount > 0)
    {
        <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
            <div class="flex items-center justify-between">
                <div class="flex-1 flex justify-between sm:hidden">
                    @* @if (Model.CurrentPage > 1)
                    {
                        <a href="?page=@(Model.CurrentPage - 1)&@ViewData["QueryString"]" 
                           class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                            Trước
                        </a>
                    }
                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <a href="?page=@(Model.CurrentPage + 1)&@ViewData["QueryString"]" 
                           class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                            Sau
                        </a>
                    } *@
                </div>
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        @* <p class="text-sm text-gray-700">
                            Hiển thị
                            <span class="font-medium">@((Model.CurrentPage - 1) * Model.PageSize + 1)</span>
                            đến
                            <span class="font-medium">@Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalCount)</span>
                            trong tổng số
                            <span class="font-medium">@Model.TotalCount</span>
                            kết quả
                        </p> *@
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-lg shadow-sm -space-x-px" aria-label="Pagination">
                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                @* @if (i == Model.CurrentPage)
                                {
                                    <span class="relative inline-flex items-center px-4 py-2 border border-primary-500 bg-primary-50 text-sm font-medium text-primary-600">
                                        @i
                                    </span>
                                }
                                else
                                {
                                    <a href="?page=@i&@ViewData["QueryString"]" 
                                       class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        @i
                                    </a>
                                } *@
                            }
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Image Upload Modal -->
<div id="image-upload-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Upload ảnh sách</h3>
            <p id="book-title" class="text-sm text-gray-600 mb-4"></p>
            
            <form id="image-upload-form" enctype="multipart/form-data">
                <input type="hidden" id="book-id" name="bookId">
                <div class="mb-4">
                    <label for="imageFile" class="block text-sm font-medium text-gray-700 mb-2">Chọn ảnh</label>
                    <input type="file" id="imageFile" name="imageFile" accept="image/*"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100">
                    <p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF, WebP. Tối đa 5MB.</p>
                </div>
                
                <div class="flex items-center justify-end space-x-3">
                    <button type="button" onclick="hideImageUploadModal()" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                        Hủy
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-lg transition-colors">
                        <i class="fas fa-upload mr-2"></i>Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
$(document).ready(function() {
    // Handle select all checkbox
    $('#select-all').change(function() {
        $('.book-checkbox').prop('checked', this.checked);
        toggleBulkActions();
    });
    
    // Handle individual checkboxes
    $('.book-checkbox').change(function() {
        toggleBulkActions();
        updateSelectAllState();
    });
    
    // Handle bulk delete
    $('#bulk-delete').click(function() {
        const selectedBooks = $('.book-checkbox:checked').length;
        if (selectedBooks > 0) {
            if (confirm(`Bạn có chắc muốn xóa ${selectedBooks} sách đã chọn?`)) {
                // Implement bulk delete
                console.log('Bulk delete', selectedBooks, 'books');
            }
        }
    });
    
    // Image upload form
    $('#image-upload-form').submit(function(e) {
        e.preventDefault();
        uploadBookImage();
    });
});

function toggleBulkActions() {
    const selectedCount = $('.book-checkbox:checked').length;
    $('#bulk-delete').prop('disabled', selectedCount === 0);
}

function updateSelectAllState() {
    const totalCheckboxes = $('.book-checkbox').length;
    const checkedCheckboxes = $('.book-checkbox:checked').length;
    
    $('#select-all').prop('checked', checkedCheckboxes === totalCheckboxes);
    $('#select-all').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
}

function deleteBook(bookId, bookTitle) {
    if (confirm(`Bạn có chắc muốn xóa sách "${bookTitle}"?`)) {
        $.ajax({
            url: '@Url.Action("DeleteBook", "Admin")/' + bookId,
            type: 'POST',
            data: {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Lỗi: ' + response.message);
                }
            },
            error: function() {
                alert('Có lỗi xảy ra khi xóa sách.');
            }
        });
    }
}

function showImageUploadModal(bookId, bookTitle) {
    $('#book-id').val(bookId);
    $('#book-title').text('Sách: ' + bookTitle);
    $('#image-upload-modal').removeClass('hidden');
}

function hideImageUploadModal() {
    $('#image-upload-modal').addClass('hidden');
    $('#image-upload-form')[0].reset();
}

function uploadBookImage() {
    const formData = new FormData();
    const bookId = $('#book-id').val();
    const imageFile = $('#imageFile')[0].files[0];
    
    if (!imageFile) {
        alert('Vui lòng chọn ảnh để upload.');
        return;
    }
    
    formData.append('imageFile', imageFile);
    formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());
    
    $.ajax({
        url: '@Url.Action("UploadBookImage", "Admin")/' + bookId,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                hideImageUploadModal();
                location.reload();
            } else {
                alert('Lỗi: ' + response.message);
            }
        },
        error: function() {
            alert('Có lỗi xảy ra khi upload ảnh.');
        }
    });
}
</script>
}