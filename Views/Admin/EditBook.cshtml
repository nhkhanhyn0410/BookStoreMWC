@* Views/Admin/EditBook.cshtml *@
@model BookStoreMVC.Models.ViewModels.BookViewModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Chỉnh sửa sách";
    ViewBag.PageTitle = $"Chỉnh sửa: {Model.Title}";
    ViewBag.ActiveMenu = "Books";
}

<!-- Page Header -->
<div class="mb-6">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="@Url.Action("Dashboard", "Admin")"
                    class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-primary-600 transition-colors">
                    <i class="fas fa-home mr-2"></i>
                    Dashboard
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-1"></i>
                    <a href="@Url.Action("Books", "Admin")"
                        class="ml-1 text-sm font-medium text-gray-700 hover:text-primary-600 transition-colors">
                        Quản lý sách
                    </a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-1"></i>
                    <span class="ml-1 text-sm font-medium text-gray-500">Chỉnh sửa sách</span>
                </div>
            </li>
        </ol>
    </nav>
</div>

<!-- Success/Error Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-6 bg-green-50 border border-green-200 text-green-600 px-4 py-3 rounded-lg">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span>@TempData["SuccessMessage"]</span>
        </div>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="mb-6 bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span>@TempData["ErrorMessage"]</span>
        </div>
    </div>
}

<form asp-action="EditBook" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data" id="edit-book-form"
    novalidate>
    @Html.AntiForgeryToken()
    @Html.HiddenFor(m => m.Id)
    @Html.HiddenFor(m => m.CreatedDate)
    @Html.HiddenFor(m => m.ImageUrl)

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Book Info Card -->
            @if (!string.IsNullOrEmpty(Model.CreatedDate.ToString()))
            {
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span class="text-sm font-medium">
                            Sách được tạo: @Model.CreatedDate.ToString("dd/MM/yyyy HH:mm") |
                            Cập nhật lần cuối: @(Model.LastUpdatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "Chưa cập nhật")
                        </span>
                    </div>
                </div>
            }

            <!-- Basic Information -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-book text-primary-600 mr-2"></i>
                        Thông tin cơ bản
                    </h3>
                </div>
                <div class="p-6 space-y-6">
                    <!-- Title -->
                    <div>
                        <label asp-for="Title" class="block text-sm font-medium text-gray-700 mb-2">
                            Tiêu đề sách <span class="text-red-500">*</span>
                        </label>
                        <input asp-for="Title" type="text"
                            class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                            placeholder="Nhập tiêu đề sách...">
                        <span asp-validation-for="Title" class="text-red-500 text-sm mt-1 block"></span>
                    </div>

                    <!-- Author -->
                    <div>
                        <label asp-for="Author" class="block text-sm font-medium text-gray-700 mb-2">
                            Tác giả <span class="text-red-500">*</span>
                        </label>
                        <input asp-for="Author" type="text"
                            class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                            placeholder="Nhập tên tác giả...">
                        <span asp-validation-for="Author" class="text-red-500 text-sm mt-1 block"></span>
                    </div>

                    <!-- ISBN -->
                    @* <div>
                        <label asp-for="ISBN" class="block text-sm font-medium text-gray-700 mb-2">
                            ISBN
                        </label>
                        <input asp-for="ISBN" type="text"
                            class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                            placeholder="Nhập mã ISBN...">
                        <span asp-validation-for="ISBN" class="text-red-500 text-sm mt-1 block"></span>
                    </div> *@

                    <!-- Description -->
                    <div>
                        <label asp-for="Description" class="block text-sm font-medium text-gray-700 mb-2">
                            Mô tả
                        </label>
                        <textarea asp-for="Description" rows="4"
                            class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors resize-none"
                            placeholder="Nhập mô tả về sách..."></textarea>
                        <span asp-validation-for="Description" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                </div>
            </div>

            <!-- Pricing & Inventory -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-dollar-sign text-green-600 mr-2"></i>
                        Giá bán & Kho hàng
                    </h3>
                </div>
                <div class="p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Price -->
                        <div>
                            <label asp-for="Price" class="block text-sm font-medium text-gray-700 mb-2">
                                Giá bán <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <input asp-for="Price" type="number" step="1000" min="0"
                                    class="block w-full pl-8 pr-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                                    placeholder="0">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 text-sm">₫</span>
                                </div>
                            </div>
                            <span asp-validation-for="Price" class="text-red-500 text-sm mt-1 block"></span>
                        </div>

                        <!-- Original Price -->
                        <div>
                            <label asp-for="Price" class="block text-sm font-medium text-gray-700 mb-2">
                                Giá gốc (nếu có)
                            </label>
                            <div class="relative">
                                <input asp-for="Price" type="number" step="1000" min="0"
                                    class="block w-full pl-8 pr-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                                    placeholder="0">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 text-sm">₫</span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">Để trống nếu không có giảm giá</p>
                            <span asp-validation-for="Price" class="text-red-500 text-sm mt-1 block"></span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Stock Quantity -->
                        <div>
                            <label asp-for="StockQuantity" class="block text-sm font-medium text-gray-700 mb-2">
                                Số lượng tồn kho <span class="text-red-500">*</span>
                            </label>
                            <input asp-for="StockQuantity" type="number" min="0"
                                class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                                placeholder="0">
                            <span asp-validation-for="StockQuantity" class="text-red-500 text-sm mt-1 block"></span>
                        </div>

                        <!-- Publisher -->
                        <div>
                            <label asp-for="Publisher" class="block text-sm font-medium text-gray-700 mb-2">
                                Nhà xuất bản
                            </label>
                            <input asp-for="Publisher" type="text"
                                class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                                placeholder="Nhập tên nhà xuất bản...">
                            <span asp-validation-for="Publisher" class="text-red-500 text-sm mt-1 block"></span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Publication Date -->
                        <div>
                            <label asp-for="PublishDate" class="block text-sm font-medium text-gray-700 mb-2">
                                Ngày xuất bản
                            </label>
                            <input asp-for="PublishDate" type="date"
                                class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
                            <span asp-validation-for="PublishDate" class="text-red-500 text-sm mt-1 block"></span>
                        </div>

                        <!-- Pages -->
                        <div>
                            <label asp-for="PageCount" class="block text-sm font-medium text-gray-700 mb-2">
                                Số trang
                            </label>
                            <input asp-for="PageCount" type="number" min="0"
                                class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                                placeholder="0">
                            <span asp-validation-for="PageCount" class="text-red-500 text-sm mt-1 block"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">

            <!-- Actions -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-cog text-gray-600 mr-2"></i>
                        Hành động
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <button type="submit"
                        class="w-full inline-flex justify-center items-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors shadow-sm">
                        <i class="fas fa-save mr-2"></i>
                        Cập nhật sách
                    </button>
                    <button type="button" onclick="saveDraft()"
                        class="w-full inline-flex justify-center items-center px-4 py-2.5 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors">
                        <i class="fas fa-file-alt mr-2"></i>
                        Lưu nháp
                    </button>
                    <a href="@Url.Action("Books", "Admin")"
                        class="w-full inline-flex justify-center items-center px-4 py-2.5 border border-red-300 text-sm font-medium rounded-lg text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                        <i class="fas fa-times mr-2"></i>
                        Hủy
                    </a>

                    <!-- View Book Link -->
                    <div class="border-t border-gray-200 pt-4">
                        <a href="@Url.Action("Details", "Book", new { id = Model.Id })" target="_blank"
                            class="w-full inline-flex justify-center items-center px-4 py-2.5 border border-blue-300 text-sm font-medium rounded-lg text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            <i class="fas fa-external-link-alt mr-2"></i>
                            Xem sách
                        </a>
                    </div>
                </div>
            </div>

            <!-- Category & Settings -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-tags text-blue-600 mr-2"></i>
                        Danh mục & Cài đặt
                    </h3>
                </div>
                <div class="p-6 space-y-6">
                    <!-- Category -->
                    <div>
                        <label asp-for="CategoryId" class="block text-sm font-medium text-gray-700 mb-2">
                            Danh mục <span class="text-red-500">*</span>
                        </label>
                        <select asp-for="CategoryId"
                            asp-items="@(new SelectList(Model?.Categories ?? new List<Category>(), "Id", "Name", Model.CategoryId))"
                            class="block w-full px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
                            <option value="">Chọn danh mục...</option>
                        </select>
                        <span asp-validation-for="CategoryId" class="text-red-500 text-sm mt-1 block"></span>
                    </div>

                    <!-- Status Checkboxes -->
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <input asp-for="IsActive" type="checkbox"
                                class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                            <label asp-for="IsActive" class="ml-2 text-sm font-medium text-gray-700">
                                Hoạt động
                            </label>
                        </div>
                        <p class="text-sm text-gray-500 ml-6">Sách sẽ hiển thị trên website khi được kích hoạt.</p>

                        <div class="flex items-center">
                            <input @*asp-for="IsFeatured"*@ type="checkbox"
                                class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                            <label @*asp-for="IsFeatured"*@ class="ml-2 text-sm font-medium text-gray-700">
                                Sách nổi bật
                            </label>
                        </div>
                        <p class="text-sm text-gray-500 ml-6">Sách sẽ xuất hiện trong danh sách sách nổi bật.</p>
                    </div>
                </div>
            </div>

            <!-- Image Management -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-images text-purple-600 mr-2"></i>
                        Hình ảnh sách
                    </h3>
                </div>
                <div class="p-6">
                    <!-- Tab Navigation -->
                    <div class="flex border-b border-gray-200 mb-6">
                        <button type="button" onclick="switchImageTab('cover')" id="cover-tab"
                            class="image-tab-btn px-4 py-2 text-sm font-medium text-primary-600 border-b-2 border-primary-600">
                            <i class="fas fa-book-open mr-2"></i>
                            Ảnh bìa
                        </button>
                        <button type="button" onclick="switchImageTab('gallery')" id="gallery-tab"
                            class="image-tab-btn px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 ml-8">
                            <i class="fas fa-images mr-2"></i>
                            Thư viện ảnh
                        </button>
                    </div>

                    <!-- Cover Image Tab -->
                    <div id="cover-image-section" class="image-tab-content">
                        <div class="space-y-4">
                            <!-- Current Cover Image -->
                            <div id="current-cover" class="@(string.IsNullOrEmpty(Model.ImageUrl) ? "hidden" : "")">
                                <div class="relative group">
                                    <img id="current-cover-img" src="@Model.ImageUrl" alt="Current cover"
                                        class="w-full h-48 object-cover rounded-lg border border-gray-200">
                                    <div
                                        class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-300 rounded-lg flex items-center justify-center">
                                        <div
                                            class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex space-x-2">
                                            <button type="button" onclick="changeCoverImage()"
                                                class="bg-white text-gray-800 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100 transition-colors">
                                                <i class="fas fa-edit mr-1"></i>
                                                Đổi ảnh
                                            </button>
                                            <button type="button" onclick="removeCurrentCover()"
                                                class="bg-red-500 text-white px-3 py-1 rounded text-sm font-medium hover:bg-red-600 transition-colors">
                                                <i class="fas fa-trash mr-1"></i>
                                                Xóa ảnh
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2 text-center">Ảnh bìa hiện tại</p>
                            </div>

                            <!-- New Cover Preview -->
                            <div id="new-cover-preview" class="hidden">
                                <div class="relative group">
                                    <img id="new-cover-preview-img" src="" alt="New cover preview"
                                        class="w-full h-48 object-cover rounded-lg border border-gray-200">
                                    <button type="button" onclick="cancelCoverChange()"
                                        class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-600 transition-colors opacity-0 group-hover:opacity-100">
                                        <i class="fas fa-times text-sm"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2 text-center">Ảnh bìa mới (chưa lưu)</p>
                            </div>

                            <!-- Cover Placeholder -->
                            <div id="cover-placeholder"
                                class="@(string.IsNullOrEmpty(Model.ImageUrl) ? "" : "hidden") w-full h-48 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-50 transition-colors"
                                onclick="document.getElementById('ImageFile').click()">
                                <div class="text-center">
                                    <i class="fas fa-book-open text-4xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-600 mb-2">Chọn ảnh bìa sách</p>
                                    <p class="text-xs text-gray-500">JPG, PNG, GIF, WebP. Tối đa 5MB</p>
                                </div>
                            </div>

                            <!-- File Input (Hidden) -->
                            <input asp-for="ImageFile" type="file" accept="image/*"
                                onchange="previewNewCoverImage(this)" id="ImageFile" class="hidden">
                            <span asp-validation-for="ImageFile" class="text-red-500 text-sm mt-1 block"></span>

                            <!-- Cover Upload Actions -->
                            <div id="cover-upload-actions"
                                class="@(string.IsNullOrEmpty(Model.ImageUrl) ? "hidden" : "") space-y-2">
                                <button type="button" onclick="uploadCoverSeparately()" id="upload-cover-btn"
                                    class="w-full inline-flex justify-center items-center px-3 py-2 border border-green-300 text-sm font-medium rounded-lg text-green-700 bg-white hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                                    <i class="fas fa-upload mr-2"></i>
                                    Upload ảnh bìa ngay
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Gallery Images Tab -->
                    <div id="gallery-image-section" class="image-tab-content hidden">
                        <div class="space-y-4">
                            <!-- Current Gallery Images -->
                            <div id="current-gallery" class="@(ViewBag.HasGalleryImages == true ? "" : "hidden")">
                                <h4 class="text-sm font-medium text-gray-700 mb-3">Thư viện ảnh hiện tại</h4>
                                <div id="current-gallery-grid" class="grid grid-cols-3 gap-2 mb-4">
                                    @* Current gallery images will be loaded here via JavaScript *@
                                </div>
                            </div>

                            <!-- Gallery Upload Area -->
                            <div>
                                <h4 class="text-sm font-medium text-gray-700 mb-3">Thêm ảnh vào thư viện</h4>
                                <div id="gallery-upload-area"
                                    class="w-full h-32 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-100 transition-colors"
                                    onclick="document.getElementById('GalleryImageFiles').click()">
                                    <div class="text-center">
                                        <i class="fas fa-images text-3xl text-gray-400 mb-2"></i>
                                        <p class="text-sm text-gray-600 mb-1">Thêm ảnh vào thư viện</p>
                                        <p class="text-xs text-gray-500">Chọn nhiều ảnh cùng lúc</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Multiple File Input (for client-side preview only) -->
                            <input type="file" accept="image/*" multiple onchange="previewGalleryImages(this)"
                                id="GalleryImageFiles" class="hidden">

                            <!-- New Gallery Preview Grid -->
                            <div id="new-gallery-preview" class="hidden">
                                <h4 class="text-sm font-medium text-gray-700 mb-3">Ảnh mới sẽ được thêm</h4>
                                <div id="gallery-preview-grid" class="grid grid-cols-3 gap-2 mb-4">
                                    <!-- New gallery images will be inserted here -->
                                </div>

                                <button type="button" onclick="uploadGallerySeparately()" id="upload-gallery-btn"
                                    class="w-full inline-flex justify-center items-center px-3 py-2 border border-blue-300 text-sm font-medium rounded-lg text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                    <i class="fas fa-upload mr-2"></i>
                                    Upload ảnh thư viện ngay
                                </button>
                            </div>

                            <!-- Gallery Instructions -->
                            <div class="text-xs text-gray-500">
                                <p>• Chọn nhiều ảnh để tạo thư viện ảnh cho sách</p>
                                <p>• Mỗi ảnh không quá 5MB</p>
                                <p>• Định dạng: JPG, PNG, GIF, WebP</p>
                                <p>• Ảnh sẽ được lưu riêng và có thể upload ngay lập tức</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <!-- Include jQuery Validation -->
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

    <script>
        let originalImageUrl = '@Model.ImageUrl';
        let hasCoverImageChanged = false;
        let galleryImages = [];
        let activeImageTab = 'cover';
        let currentGalleryImages = []; // Loaded from server

        // Tab switching
        function switchImageTab(tab) {
            document.querySelectorAll('.image-tab-btn').forEach(btn => {
                btn.classList.remove('text-primary-600', 'border-primary-600');
                btn.classList.add('text-gray-500', 'border-transparent');
            });

            document.getElementById(tab + '-tab').classList.remove('text-gray-500', 'border-transparent');
            document.getElementById(tab + '-tab').classList.add('text-primary-600', 'border-primary-600');

            document.querySelectorAll('.image-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            document.getElementById(tab + '-image-section').classList.remove('hidden');
            activeImageTab = tab;
        }

        // Cover image management functions
        function changeCoverImage() {
            document.getElementById('ImageFile').click();
        }

        function previewNewCoverImage(input) {
            const file = input.files[0];
            if (file) {
                if (!isValidImageFile(file)) {
                    showNotification('File không hợp lệ. Chỉ chấp nhận JPG, PNG, GIF, WebP dưới 5MB.', 'error');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('new-cover-preview-img').src = e.target.result;
                    document.getElementById('new-cover-preview').classList.remove('hidden');
                    document.getElementById('current-cover').classList.add('hidden');
                    document.getElementById('cover-placeholder').classList.add('hidden');
                    document.getElementById('cover-upload-actions').classList.remove('hidden');
                    hasCoverImageChanged = true;
                };
                reader.readAsDataURL(file);
            }
        }

        function cancelCoverChange() {
            document.getElementById('ImageFile').value = '';
            document.getElementById('new-cover-preview').classList.add('hidden');

            if (originalImageUrl) {
                document.getElementById('current-cover').classList.remove('hidden');
            } else {
                document.getElementById('cover-placeholder').classList.remove('hidden');
                document.getElementById('cover-upload-actions').classList.add('hidden');
            }
            hasCoverImageChanged = false;
        }

        function removeCurrentCover() {
            if (confirm('Bạn có chắc chắn muốn xóa ảnh bìa hiện tại?')) {
                fetch(`/admin/books/remove-image/@Model.Id`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('current-cover').classList.add('hidden');
                            document.getElementById('cover-placeholder').classList.remove('hidden');
                            document.getElementById('cover-upload-actions').classList.add('hidden');
                            originalImageUrl = '';
                            showNotification('Ảnh bìa đã được xóa thành công!', 'success');
                        } else {
                            showNotification(data.message || 'Có lỗi xảy ra khi xóa ảnh bìa!', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Có lỗi xảy ra khi xóa ảnh bìa!', 'error');
                    });
            }
        }

        function uploadCoverSeparately() {
            const fileInput = document.getElementById('ImageFile');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('Vui lòng chọn ảnh bìa trước khi upload!', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('imageFile', file);
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

            const uploadBtn = document.getElementById('upload-cover-btn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang tải...';
            uploadBtn.disabled = true;

            fetch(`/admin/books/upload-image/@Model.Id`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('current-cover-img').src = data.imageUrl;
                        document.getElementById('current-cover').classList.remove('hidden');
                        document.getElementById('new-cover-preview').classList.add('hidden');

                        originalImageUrl = data.imageUrl;
                        fileInput.value = '';
                        hasCoverImageChanged = false;

                        showNotification('Ảnh bìa đã được tải lên thành công!', 'success');
                    } else {
                        showNotification(data.message || 'Có lỗi xảy ra khi tải lên ảnh bìa!', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Có lỗi xảy ra khi tải lên ảnh bìa!', 'error');
                })
                .finally(() => {
                    uploadBtn.innerHTML = originalText;
                    uploadBtn.disabled = false;
                });
        }

        // Gallery images management functions
        function previewGalleryImages(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;

            const invalidFiles = files.filter(file => !isValidImageFile(file));
            if (invalidFiles.length > 0) {
                showNotification(`${invalidFiles.length} file không hợp lệ sẽ bị bỏ qua.`, 'warning');
            }

            const validFiles = files.filter(file => isValidImageFile(file));
            if (validFiles.length === 0) return;

            // Clear previous gallery selection
            galleryImages = [];

            validFiles.forEach(file => {
                galleryImages.push(file);
            });

            updateGalleryPreview();
            input.value = '';
        }

        function updateGalleryPreview() {
            const grid = document.getElementById('gallery-preview-grid');
            const container = document.getElementById('new-gallery-preview');

            if (galleryImages.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            grid.innerHTML = '';

            galleryImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    addGalleryImageToPreview(e.target.result, file.name, index);
                };
                reader.readAsDataURL(file);
            });
        }

        function addGalleryImageToPreview(src, fileName, index) {
            const grid = document.getElementById('gallery-preview-grid');

            const imageDiv = document.createElement('div');
            imageDiv.className = 'relative group gallery-image';
            imageDiv.dataset.index = index;

            imageDiv.innerHTML = `
                                                    <img src="${src}" alt="${fileName}" class="w-full h-24 object-cover rounded border border-gray-200">
                                                    <button type="button" onclick="removeGalleryImage(${index})" 
                                                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition-colors opacity-0 group-hover:opacity-100 text-xs">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 rounded-b truncate opacity-0 group-hover:opacity-100 transition-opacity">
                                                        ${fileName}
                                                    </div>
                                                `;

            grid.appendChild(imageDiv);
        }

        function removeGalleryImage(index) {
            galleryImages.splice(index, 1);
            updateGalleryPreview();
        }

        function uploadGallerySeparately() {
            if (galleryImages.length === 0) {
                showNotification('Vui lòng chọn ảnh thư viện trước khi upload!', 'error');
                return;
            }

            const formData = new FormData();
            galleryImages.forEach(file => {
                formData.append('galleryFiles', file);
            });
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

            const uploadBtn = document.getElementById('upload-gallery-btn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang tải...';
            uploadBtn.disabled = true;

            fetch(`/admin/books/upload-gallery/@Model.Id`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Refresh current gallery display
                        loadCurrentGallery();
                        // Clear new gallery preview
                        galleryImages = [];
                        updateGalleryPreview();

                        showNotification(`${data.uploadedCount} ảnh đã được tải lên thành công!`, 'success');
                    } else {
                        showNotification(data.message || 'Có lỗi xảy ra khi tải lên ảnh thư viện!', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Có lỗi xảy ra khi tải lên ảnh thư viện!', 'error');
                })
                .finally(() => {
                    uploadBtn.innerHTML = originalText;
                    uploadBtn.disabled = false;
                });
        }

        function loadCurrentGallery() {
            // Load current gallery images from server
            fetch(`/admin/books/gallery/@Model.Id`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentGalleryImages = data.images;
                        renderCurrentGallery();
                    }
                })
                .catch(error => {
                    console.error('Error loading gallery:', error);
                });
        }

        function renderCurrentGallery() {
            const container = document.getElementById('current-gallery');
            const grid = document.getElementById('current-gallery-grid');

            if (currentGalleryImages.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            grid.innerHTML = '';

            currentGalleryImages.forEach((image, index) => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'relative group';

                imageDiv.innerHTML = `
                                                        <img src="${image.url}" alt="Gallery image ${index + 1}" class="w-full h-24 object-cover rounded border border-gray-200">
                                                        <button type="button" onclick="removeCurrentGalleryImage('${image.id}')" 
                                                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition-colors opacity-0 group-hover:opacity-100 text-xs">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    `;

                grid.appendChild(imageDiv);
            });
        }

        function removeCurrentGalleryImage(imageId) {
            if (confirm('Bạn có chắc chắn muốn xóa ảnh này khỏi thư viện?')) {
                fetch(`/admin/books/remove-gallery-image/${imageId}`, {
                    method: 'DELETE',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadCurrentGallery(); // Refresh gallery
                            showNotification('Ảnh đã được xóa khỏi thư viện!', 'success');
                        } else {
                            showNotification(data.message || 'Có lỗi xảy ra khi xóa ảnh!', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Có lỗi xảy ra khi xóa ảnh!', 'error');
                    });
            }
        }

        // File validation helper
        function isValidImageFile(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            const maxSize = 5 * 1024 * 1024; // 5MB

            return validTypes.includes(file.type) && file.size <= maxSize;
        }

        // Save draft functionality
        function saveDraft() {
            showNotification('Đang lưu nháp...', 'info');
            setTimeout(() => {
                showNotification('Nháp đã được lưu thành công!', 'success');
            }, 1000);
        }

        // Form validation and initialization
        $(document).ready(function () {
            // Load current gallery on page load
            loadCurrentGallery();

            // Form submission handling
            $('#edit-book-form').on('submit', function (e) {
                if (!$(this).valid()) {
                    e.preventDefault();
                    showNotification('Vui lòng kiểm tra và điền đầy đủ thông tin bắt buộc!', 'error');

                    const firstError = $('.field-validation-error:first');
                    if (firstError.length) {
                        firstError[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });

            // Warn about unsaved changes
            let formChanged = false;
            $('#edit-book-form input, #edit-book-form select, #edit-book-form textarea').on('change', function () {
                formChanged = true;
            });

            $(window).on('beforeunload', function (e) {
                if (formChanged || hasCoverImageChanged || galleryImages.length > 0) {
                    return 'Bạn có thay đổi chưa được lưu. Bạn có chắc chắn muốn rời khỏi trang này?';
                }
            });

            $('#edit-book-form').on('submit', function () {
                $(window).off('beforeunload');
            });
        });

        // Notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 max-w-sm w-full bg-white border rounded-lg shadow-lg transform transition-all duration-300 ${type === 'success' ? 'border-green-200' :
                type === 'error' ? 'border-red-200' :
                    type === 'warning' ? 'border-yellow-200' : 'border-blue-200'
                }`;

            notification.innerHTML = `
                                                    <div class="p-4">
                                                        <div class="flex items-start">
                                                            <div class="flex-shrink-0">
                                                                <i class="fas ${type === 'success' ? 'fa-check-circle text-green-400' :
                    type === 'error' ? 'fa-times-circle text-red-400' :
                        type === 'warning' ? 'fa-exclamation-triangle text-yellow-400' :
                            'fa-info-circle text-blue-400'
                }"></i>
                                                            </div>
                                                            <div class="ml-3 w-0 flex-1 pt-0.5">
                                                                <p class="text-sm font-medium text-gray-900">${message}</p>
                                                            </div>
                                                            <div class="ml-4 flex-shrink-0 flex">
                                                                <button class="inline-flex text-gray-400 hover:text-gray-500" onclick="this.parentElement.parentElement.parentElement.parentElement.remove()">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
}

@section Styles {
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Custom file input styling */
        input[type="file"]::-webkit-file-upload-button {
            visibility: hidden;
        }

        input[type="file"]::before {
            content: 'Chọn file';
            display: inline-block;
            background: linear-gradient(top, #f9f9f9, #e3e3e3);
            border: 1px solid #999;
            border-radius: 3px;
            padding: 5px 8px;
            outline: none;
            white-space: nowrap;
            -webkit-user-select: none;
            cursor: pointer;
            text-shadow: 1px 1px #fff;
            font-weight: 700;
            font-size: 10pt;
        }

        input[type="file"]:hover::before {
            border-color: black;
        }

        input[type="file"]:active::before {
            background: -webkit-linear-gradient(top, #e3e3e3, #f9f9f9);
        }

        /* Form validation styling */
        .field-validation-error {
            display: block;
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .input-validation-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        /* Image overlay effects */
        .group:hover .group-hover\:opacity-100 {
            opacity: 1;
        }

        .group:hover .group-hover\:bg-opacity-40 {
            background-opacity: 0.4;
        }
    </style>
}